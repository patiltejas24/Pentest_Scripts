##############################################################################################################################################################################################
#External_Enum is a bash script to automate Information Gathering from Internet. It runs whois, hostsearch and dnssearch via DNS Dumpster API, Recon-ng, theharvester and combines all the
# result in to one file. Resulting in one file containing all the found domains and the email addresses.     
#
#Copyright (C) 2016 Vijay Kumar ( bitvijays )
#
#This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 
#of the License, or (at your option) #any later version.
#
#This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the 
#GNU General Public License for #more details.
#
#You should have received a copy of the GNU General Public License along with this program. If not, see http://www.gnu.org/licenses/.
#
#
################################################################################################################################################################################################

#!/bin/bash

function usage {
	echo "usage: $1 [-d domain]"
}
domain=""

while getopts "d:" OPT; do
	case $OPT in
		d) domain=$OPTARG;;
		*) usage $0; exit;;
	esac
done

if [ ! -d ./output ]; then
	  mkdir ./output
fi

###Perform check if $domain is populated
if [[ -z $domain ]]; then 
	usage $0;
	exit;
fi

stamp=$(date +"%m_%d_%Y")

###Perform Whois of the Domain
if [ ! -f ./output/whois.$domain ]; then
	echo "[+] Performing whois"
	whois -H $domain > ./output/whois.$domain
else 
	echo "[+] whois results present"
fi

if [ ! -f ./output/hostsearch.$domain ]; then
###Perform hostsearch via DNS Dumpster API
	echo "[+] Performing DNS Dumpster"
	curl -s http://api.hackertarget.com/hostsearch/?q=$domain > ./output/hostsearch.$domain
	cat ./output/hostsearch.$domain | awk -F , '{print "\""$1"\""",""\""$2"\""}' > ./output/hostsearch.$domain.csv
else
	echo "[+] DNS Dumpster results present"
fi

if [ ! -f ./output/dnslookup.$domain ]; then
###Perform DNS queries
	echo "[+] Performing DNS Queries"
	curl -s http://api.hackertarget.com/dnslookup/?q=$domain > ./output/dnslookup.$domain
else
	echo "[+] DNS Queries Results present"
fi

###Doing Recon-ng enumall.sh
### You might want to change the file saving location
if [ ! -f ./output/$domain$stamp.csv ]; then
	echo "[+] Performing Recon-ng queries"
	/opt/domain/enumall.sh $domain
	cp /tmp/$domain$stamp.csv ./output/
else
	echo "[+] Recon-ng results present"
fi

###Run harvestor
if [ ! -f ./output/harvester.$domain.out ]; then
	echo "[+] Performing theharvester"
	theharvester -d $domain -b all -f ./output/harvester.$domain > ./output/harvester.$domain.out
else
	echo "[+] theharvester results present"
fi

if [ ! -f ./output/dnsenum.$domain ]; then
	echo "[+] Performing DNSenum queries"
###DNS Enum
	dnsenum -o ./output/dnsenum.$domain.xml $domain > ./output/dnsenum.$domain

##Copying hostsearch via DNS Dumpster API to final output
	cp ./output/hostsearch.$domain.csv ./output/final_output.csv

#Adding , to the end of final_output
	sed -i -e "s/$/,/" ./output/final_output.csv 

###Appending the data generated from recon-ng to final_output.csv
	cat ./output/$domain$stamp.csv >> ./output/final_output.csv 

###Copying data from theharvester between Resolving to virtual to final_output.csv
	sed -n "/Resolving/,/Virtual/{/Resolving/b;/Virtual/b;p}" ./output/harvester.$domain.out | awk -F : '{print "\"" $2 "\",\"" $1"\""}' >> ./output/final_output.csv 

###Copying data from theharvester between Virtual to Saving to final_output.csv
	sed -n "/Virtual/,/Saving/{/Virtual/b;/Saving/b;p}" ./output/harvester.$domain.out | awk '{print "\"" $2 "\",\"" $1"\""}' >> ./output/final_output.csv

###Copying data from theharvester between Email to Hosts and saving it to email_output.csv
	sed -n "/Emails/,/Hosts/{/Email/b;/Hosts/b;p}" ./output/harvester.$domain.out | grep -v "-" | awk '{print "\"" $1 "\""}' >> ./output/emails_output.csv

###Get the final output
	cat ./output/final_output.csv | cut -d , -f1-2 | grep -v = | sort | uniq > ./output/final_$domain.csv
	echo "The result are stored in ./output/final_$domain.csv"

else
	echo "[+] dnsenum results present"
	echo "The result are stored in ./output/final_$domain.csv"
fi



